{% extends 'navbar.html' %}
{% load i18n %}

{% block title %}
    {% trans 'Add service' %}
{% endblock %}

{% block main %}
    <div class="container-fluid">
        <form method="post" id="visa-form">
            {% csrf_token %}
            <div class="row">
                <div class="col">
                    <div class="row">
                        <div class="col-3">
                            <label for="{{ form.specification.id_for_label }}">{{ form.specification.label }}</label>
                        </div>
                        <div class="col-9">
                            {{ form.specification }}
                            <span class="text-danger">{{ form.specification.errors }}</span>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="md-form">
                        <label for="{{ form.extension_request_date.id_for_label }}">{{ form.extension_request_date.label }}</label>
                        {{ form.extension_request_date }}
                        <span class="text-danger">{{ form.extension_request_date.errors }}</span>
                    </div>
                </div>
                <div class="col">
                    <div class="row">
                        <div class="col-3">
                            <label for="{{ form.request_type.id_for_label }}">{{ form.request_type.label }}</label>
                        </div>
                        <div class="col-9">
                            {{ form.request_type }}
                            <span class="text-danger">{{ form.request_type.errors }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="md-form">
                        {{ form.passport_no }}
                        <label for="{{ form.passport_no.id_for_label }}">{{ form.passport_no.label }}</label>
                        <span class="text-danger">{{ form.passport_no.errors }}</span>
                    </div>
                </div>
                <div class="col">
                    <div class="md-form">
                        {{ form.passport_issuance_date }}
                        <label for="{{ form.passport_issuance_date.id_for_label }}">{{ form.passport_issuance_date.label }}</label>
                        <span class="text-danger">{{ form.passport_issuance_date.errors }}</span>
                    </div>
                </div>
                <div class="col">
                    <div class="md-form">
                        {{ form.passport_expiration_date }}
                        <label for="{{ form.passport_expiration_date.id_for_label }}">{{ form.passport_expiration_date.label }}</label>
                        <span class="text-danger">{{ form.passport_expiration_date.errors }}</span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="md-form">
                        {{ form.visa_no }}
                        <label for="{{ form.visa_no.id_for_label }}">{{ form.visa_no.label }}</label>
                        <span class="text-danger">{{ form.visa_no.errors }}</span>
                    </div>
                </div>
                <div class="col">
                    <div class="md-form">
                        {{ form.visa_issuance_date }}
                        <label for="{{ form.visa_issuance_date.id_for_label }}">{{ form.visa_issuance_date.label }}</label>
                        <span class="text-danger">{{ form.visa_issuance_date.errors }}</span>
                    </div>
                </div>
                <div class="col">
                    <div class="md-form">
                        {{ form.visa_expiration_date }}
                        <label for="{{ form.visa_expiration_date.id_for_label }}">{{ form.visa_expiration_date.label }}</label>
                        <span class="text-danger">{{ form.visa_expiration_date.errors }}</span>
                    </div>
                    <div class="hidden">
                        {{ form.tutelary_entity }}
                    </div>
                </div>
            </div>
        </form>
    </div>

    {% if entity_form %}
        <div id="entity" class="container-fluid hidden">
            <form method="post" id="entity-form" action="{% url 'services:entity_create' %}">
                {% csrf_token %}
                <div class="row">
                    <div class="col">
                        <h1 class="h1 text-center">{% trans 'Tutelary Entity data' %}</h1>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="md-form">
                            {{ entity_form.name }}
                            <label for="{{ entity_form.name.id_for_label }}">{{ entity_form.name.label }}</label>
                            <span class="text-danger">{{ entity_form.name.errors }}</span>
                            <ol id="entity-list"></ol>
                        </div>
                    </div>
                    <div class="col">
                        <div class="md-form">
                            {{ entity_form.localization }}
                            <label for="{{ entity_form.localization.id_for_label }}">{{ entity_form.localization.label }}</label>
                            <span class="text-danger">{{ entity_form.localization.errors }}</span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="md-form">
                            {{ entity_form.identification_no }}
                            <label for="{{ entity_form.identification_no.id_for_label }}">{{ entity_form.identification_no.label }}</label>
                            <span class="text-danger">{{ entity_form.identification_no.errors }}</span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="md-form">
                            {{ entity_form.issuance_date }}
                            <label for="{{ entity_form.issuance_date.id_for_label }}">{{ entity_form.issuance_date.label }}</label>
                            <span class="text-danger">{{ entity_form.issuance_date.errors }}</span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="md-form">
                            {{ entity_form.expiration_date }}
                            <label for="{{ entity_form.expiration_date.id_for_label }}">{{ entity_form.expiration_date.label }}</label>
                            <span class="text-danger">{{ entity_form.expiration_date.errors }}</span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="md-form">
                            {{ entity_form.telephone }}
                            <label for="{{ entity_form.telephone.id_for_label }}">{{ entity_form.telephone.label }}</label>
                            <span class="text-danger">{{ entity_form.telephone.errors }}</span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="md-form">
                            {{ entity_form.email }}
                            <label for="{{ entity_form.email.id_for_label }}">{{ entity_form.email.label }}</label>
                            <span class="text-danger">{{ entity_form.email.errors }}</span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    {% endif %}
    <div class="row">
        <button type="submit" class="btn btn-default" id="submit">{% trans 'Accept' %}</button>
        <button class="btn btn-default" id="obtener">Obtener</button>
    </div>
{% endblock %}

{% block script %}
    <script>
        $(function () {
            let specification = $('#{{ form.specification.id_for_label }}');
            const entityForm = $('#entity-form');
            const visaForm = $('#visa-form');
            let createNewEntity = true;

            specification.change(function () {
                if ($(this).val() === 'VT') {
                    $('#entity').removeClass('hidden');
                } else {
                    $('#entity').addClass('hidden');
                }
            });

            $('button[type=submit]').click(function (event) {
                event.preventDefault();
                if (createNewEntity && specification.val() === 'VT') {
                    $.ajax(entityForm.attr('action'), {
                        method: 'POST',
                        data: {
                            'name': $('#{{ entity_form.name.id_for_label }}').val(),
                            'localization': $('#{{ entity_form.localization.id_for_label }}').val(),
                            'identification_no': $('#{{ entity_form.identification_no.id_for_label }}').val(),
                            'issuance_date': $('#{{ entity_form.issuance_date.id_for_label }}').val(),
                            'expiration_date': $('#{{ entity_form.expiration_date.id_for_label }}').val(),
                            'telephone': $('#{{ entity_form.telephone.id_for_label }}').val(),
                            'email': $('#{{ entity_form.email.id_for_label }}').val(),
                        },
                        success: function (response) {
                            console.log(response['pk']);
                            $('#{{ form.tutelary_entity.id_for_label }}').attr('value', response['pk']);
                        },
                        error: function (response, status) {
                            swal('Ha ocurrido un error', response.responseText, status);
                            console.log(response);
                        }
                    });
                }
                visaForm.submit();
            });

            function refillEntityData(event, entity) {
                createNewEntity = false;
                $('#{{ entity_form.name.id_for_label }}').val(entity['name']);
                $('#{{ entity_form.localization.id_for_label }}').val(entity['localization']);
                $('#{{ entity_form.identification_no.id_for_label }}').val(entity['identification_no']);
                $('#{{ entity_form.issuance_date.id_for_label }}').val(entity['issuance_date']);
                $('#{{ entity_form.expiration_date.id_for_label }}').val(entity['expiration_date']);
                $('#{{ entity_form.telephone.id_for_label }}').val(entity['telephone']);
                $('#{{ entity_form.email.id_for_label }}').val(entity['email']);
            }

            let typingTimer; //timer identifier
            const typingInterval = 1000; //
            let entity_name = $('#{{ entity_form.name.id_for_label }}');
            entity_name.keyup(function () {
                clearTimeout(typingTimer);
                if ($(this).val) {
                    typingTimer = setTimeout(doneTyping, typingInterval);
                }
            });

            function doneTyping() {
                let result = '';
                let en_list = [];
                $.ajax("{% url 'services:entity_search' %}", {
                    method: 'GET',
                    data: {'name': entity_name.val()},
                    success: function (data) {
                        for (let i = 0; i < data.length; i++) {
                            en_list[i] = data[i];
                            result += '<li><a href="#" id="entity-' + en_list[i]['pk'] + '">' + en_list[i]['name'] +
                                '</a></li>' + '\n';
                        }
                        $("#entity-list").html(result);
                        for (let i = 0; i < en_list.length; i++) {
                            let ent = $('#entity-' + en_list[i]['pk']);
                            ent.on('custom', refillEntityData);
                            ent.on('click', function (event) {
                                event.preventDefault();
                                ent.trigger('custom', [en_list[i]]);
                            });
                        }
                    },
                    error: function (response, status) {
                    }
                });
            }
        });
    </script>
{% endblock %}